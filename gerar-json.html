<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Builder - Rigolim v4.8.7</title>
<style>
  body {
    font-family: "Inter", sans-serif;
    background: #f7f7f7;
    margin: 0;
    padding: 40px;
    color: #333;
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
    background: #fff;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }
  h1 { text-align: center; margin-bottom: 20px; }
  button {
    background: #5d2f03;
    color: #fff;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin: 4px;
  }
  button:hover { background: #7a4310; }
  input, textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin: 4px 0;
    font-size: 14px;
  }
  textarea { min-height: 60px; }
  details {
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 8px;
    background: #fafafa;
    padding: 8px;
  }
  summary { font-weight: 600; cursor: pointer; }
  .level { margin-left: 20px; }
  pre {
    background: #1e1e1e;
    color: #f8f8f2;
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
  }
  .actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 16px;
  }
  #status { text-align: center; font-weight: 600; margin: 10px 0; }
  #status.error { color: #c62828; }
  #status.success { color: #2e7d32; }
  #searchBar {
    width: 100%;
    margin: 10px 0 8px 0;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 15px;
  }

  .error-dup { border: 2px solid #e53935 !important; background: #ffebee !important; }
  .error-syntax { border: 2px solid #fbc02d !important; background: #fff8e1 !important; }

  .search-highlight {
    background-color: #fff3cd !important;
    animation: pulse 1.2s infinite alternate;
  }
  @keyframes pulse {
    from { box-shadow: 0 0 4px 1px rgba(255, 193, 7, 0.4); }
    to { box-shadow: 0 0 10px 2px rgba(255, 193, 7, 0.8); }
  }
  .hidden { display: none !important; }

  .allow-empty {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #555;
    margin-top: 7px;
  }
  .allow-empty input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: #5d2f03;
    cursor: pointer;
  }
  #status div.error-item {
    margin: 4px 0;
    border-bottom: 1px dotted #ccc;
    cursor: pointer;
  }
  .github-token {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f4f4f4;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  .github-token input {
    flex: 1;
    font-size: 13px;
    border: 1px solid #bbb;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ§© JSON Builder - Rigolim v4.8.7</h1>
  <!--<p style="text-align: center;font-size: 11px;">Key = <span style="color: #cdcdcd;"></span></p>-->

  <div class="github-token">
    <label><b>ğŸ” Token GitHub:</b></label>
    <input type="password" id="githubToken" placeholder="Cole aqui seu token (escopo: repo)">
  </div>

  <div class="actions">
    <button onclick="addCampaign()">â• Campanha</button>
    <button onclick="importJson()">ğŸ“‚ Importar JSON</button>
    <button onclick="importFromURL()">ğŸŒ Importar via URL</button>
    <button onclick="save()">ğŸ’¾ Salvar</button>
    <button onclick="validateJson()">ğŸ§  Validar</button>
    <button onclick="copyJson()">ğŸ“‹ Copiar</button>
    <button onclick="downloadJson()">ğŸ’¾ Baixar</button>
    <button onclick="toggleAll()">ğŸ”½ Expandir Tudo</button>
    <button onclick="uploadToGitHub()">â¬†ï¸ Enviar para GitHub</button>
    <button onclick="window.open('https://liv-ia-hub.github.io/gerador-de-url/', '_blank')">ğŸ”— Gerador de URLs Parametrizadas</button>
    <button onclick="clearAll()">ğŸ—‘ï¸ Limpar Tudo</button>
  </div>

  <input id="searchBar" placeholder="ğŸ” Buscar por nome, ID ou parÃ¢metro..." oninput="applySearch(this.value)">
  <div id="status"></div>
  <div id="builder"></div>

  <h2>Preview</h2>
  <pre id="jsonPreview">{}</pre>
</div>

<script>
const GITHUB_USER = "RigolimHairandco";
const GITHUB_REPO = "gerador-de-url";
const GITHUB_FILE_PATH = "arquivo-json/config.json";
const GITHUB_BRANCH = "main";

let data = JSON.parse(localStorage.getItem("json_builder_v486") || '{"campanhas": []}');
const builder = document.getElementById("builder");
const jsonPreview = document.getElementById("jsonPreview");
const statusDiv = document.getElementById("status");
let openNewKey = null;
let allExpanded = false;

// ===== NOVA FUNÃ‡ÃƒO: UPLOAD PARA GITHUB =====
async function uploadToGitHub() {
  const token = document.getElementById("githubToken").value.trim();
  if (!token) return alert("âš ï¸ Cole seu token GitHub antes de enviar.");
  const jsonContent = JSON.stringify(generateFinalJson(), null, 2);
  const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`;

  try {
    const getRes = await fetch(`${apiUrl}?ref=${GITHUB_BRANCH}`, {
      headers: { Authorization: `token ${token}` }
    });
    const fileData = await getRes.json();
    const sha = fileData.sha || null;

    const res = await fetch(apiUrl, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "AtualizaÃ§Ã£o automÃ¡tica pelo JSON Builder Rigolim",
        content: btoa(unescape(encodeURIComponent(jsonContent))),
        branch: GITHUB_BRANCH,
        sha
      })
    });

    if (res.ok) {
      alert("âœ… JSON atualizado com sucesso no GitHub!");
    } else {
      const err = await res.json();
      console.error(err);
      alert("âŒ Erro ao enviar para o GitHub:\n" + (err.message || "Verifique o token ou permissÃµes."));
    }
  } catch (err) {
    console.error(err);
    alert("âš ï¸ Falha na conexÃ£o com o GitHub.");
  }
}

// ======== FUNÃ‡Ã•ES DE REORDENAÃ‡ÃƒO ========
function moveItem(array, from, to) {
  if (to < 0 || to >= array.length) return;
  const item = array.splice(from, 1)[0];
  array.splice(to, 0, item);
  save();
}

function moveUp(type, c, m, ch) {
  if (type === 'campanha') moveItem(data.campanhas, c, c - 1);
  else if (type === 'marca') moveItem(data.campanhas[c].marcas, m, m - 1);
  else if (type === 'canal') moveItem(data.campanhas[c].marcas[m].canais, ch, ch - 1);
}

function moveDown(type, c, m, ch) {
  if (type === 'campanha') moveItem(data.campanhas, c, c + 1);
  else if (type === 'marca') moveItem(data.campanhas[c].marcas, m, m + 1);
  else if (type === 'canal') moveItem(data.campanhas[c].marcas[m].canais, ch, ch + 1);
}

// ======== RESTANTE DO CÃ“DIGO ORIGINAL ========
let openNewKeyStorage = null;
function save() { localStorage.setItem("json_builder_v486", JSON.stringify(data)); render(); }
function addCampaign(){data.campanhas.push({nome:"",marcas:[]});openNewKey=`c-${data.campanhas.length-1}`;save();}
function addBrand(c){data.campanhas[c].marcas.push({nome:"",canais:[]});openNewKey=`c-${c}-m-${data.campanhas[c].marcas.length-1}`;save();}
function addChannel(c,m){data.campanhas[c].marcas[m].canais.push({nome:"",id:"",params:[]});openNewKey=`c-${c}-m-${m}-ch-${data.campanhas[c].marcas[m].canais.length-1}`;save();}
function addParam(c,m,ch){data.campanhas[c].marcas[m].canais[ch].params.push({nome:"",valor:"",permitirVazio:false});save();}
function removeCampaign(i){if(confirm("Remover campanha?")){data.campanhas.splice(i,1);save();}}
function removeBrand(c,m){if(confirm("Remover marca?")){data.campanhas[c].marcas.splice(m,1);save();}}
function removeChannel(c,m,ch){if(confirm("Remover canal?")){data.campanhas[c].marcas[m].canais.splice(ch,1);save();}}
function removeParam(c,m,ch,p){if(confirm("Remover parÃ¢metro?")){data.campanhas[c].marcas[m].canais[ch].params.splice(p,1);save();}}
function duplicateCampaign(i){const clone=JSON.parse(JSON.stringify(data.campanhas[i]));data.campanhas.splice(i+1,0,clone);openNewKey=`c-${i+1}`;save();}
function duplicateBrand(c,m){const clone=JSON.parse(JSON.stringify(data.campanhas[c].marcas[m]));data.campanhas[c].marcas.splice(m+1,0,clone);openNewKey=`c-${c}-m-${m+1}`;save();}
function duplicateChannel(c,m,ch){const clone=JSON.parse(JSON.stringify(data.campanhas[c].marcas[m].canais[ch]));clone.id="";data.campanhas[c].marcas[m].canais.splice(ch+1,0,clone);openNewKey=`c-${c}-m-${m}-ch-${ch+1}`;save();}
function duplicateParam(c,m,ch,p){const clone=JSON.parse(JSON.stringify(data.campanhas[c].marcas[m].canais[ch].params[p]));data.campanhas[c].marcas[m].canais[ch].params.splice(p+1,0,clone);save();}
function toggleAllowEmpty(c,m,ch,p,checked){data.campanhas[c].marcas[m].canais[ch].params[p].permitirVazio=checked;save();}
function toggleAll(){const details=builder.querySelectorAll("details");allExpanded=!allExpanded;details.forEach(d=>d.open=allExpanded);const btn=document.querySelector('button[onclick="toggleAll()"]');btn.textContent=allExpanded?"ğŸ”¼ Colapsar Tudo":"ğŸ”½ Expandir Tudo";}
function getOpenDetails(){return[...document.querySelectorAll("details[open]")].map(el=>el.dataset.key);}
function restoreOpenDetails(keys){keys.forEach(k=>{const el=document.querySelector(`details[data-key="${k}"]`);if(el)el.open=true;});if(openNewKey){const el=document.querySelector(`details[data-key="${openNewKey}"]`);if(el)el.open=true;openNewKey=null;}}
function render(){
  const openKeys=getOpenDetails();
  builder.innerHTML="";
  data.campanhas.forEach((campanha,cIndex)=>{
    const cEl=document.createElement("details");
    cEl.dataset.key=`c-${cIndex}`;
    cEl.innerHTML=`<summary>ğŸ“ <b>Campanha:</b><input value="${campanha.nome||''}" placeholder="Nome da campanha" onblur="data.campanhas[${cIndex}].nome=this.value; save()">
    <button onclick='addBrand(${cIndex})'>+ Marca</button>
    <button onclick='duplicateCampaign(${cIndex})'>ğŸ“„</button>
    <button onclick='removeCampaign(${cIndex})'>ğŸ—‘ï¸</button>
    <button onclick='moveUp("campanha", ${cIndex})'>â¬†ï¸</button>
    <button onclick='moveDown("campanha", ${cIndex})'>â¬‡ï¸</button></summary>`;
    campanha.marcas.forEach((marca,mIndex)=>{
      const mEl=document.createElement("details");
      mEl.className="level";
      mEl.dataset.key=`c-${cIndex}-m-${mIndex}`;
      mEl.innerHTML=`<summary>ğŸ·ï¸ <b>Marca:</b><input value="${marca.nome||''}" placeholder="Nome da marca" onblur="data.campanhas[${cIndex}].marcas[${mIndex}].nome=this.value; save()">
      <button onclick='addChannel(${cIndex},${mIndex})'>+ Canal</button>
      <button onclick='duplicateBrand(${cIndex},${mIndex})'>ğŸ“„</button>
      <button onclick='removeBrand(${cIndex},${mIndex})'>ğŸ—‘ï¸</button>
      <button onclick='moveUp("marca", ${cIndex}, ${mIndex})'>â¬†ï¸</button>
      <button onclick='moveDown("marca", ${cIndex}, ${mIndex})'>â¬‡ï¸</button></summary>`;
      marca.canais.forEach((canal,chIndex)=>{
        const chEl=document.createElement("details");
        chEl.className="level";
        chEl.dataset.key=`c-${cIndex}-m-${mIndex}-ch-${chIndex}`;
        chEl.innerHTML=`<summary>ğŸ“¡ <b>Canal:</b><input id="input-${cIndex}-${mIndex}-${chIndex}-id" value="${canal.nome||''}" placeholder="Nome do canal" onblur="data.campanhas[${cIndex}].marcas[${mIndex}].canais[${chIndex}].nome=this.value; save()"></summary>
        <label><b>ID [Parceiro Tray]:</b></label>
        <input id="id-${cIndex}-${mIndex}-${chIndex}" type="number" value="${canal.id||''}" placeholder="Ex: 7120" onblur="data.campanhas[${cIndex}].marcas[${mIndex}].canais[${chIndex}].id=this.value; save()">
        <button onclick='addParam(${cIndex},${mIndex},${chIndex})'>+ ParÃ¢metro</button>
        <button onclick='duplicateChannel(${cIndex},${mIndex},${chIndex})'>ğŸ“„</button>
        <button onclick='removeChannel(${cIndex},${mIndex},${chIndex})'>ğŸ—‘ï¸</button>
        <button onclick='moveUp("canal", ${cIndex}, ${mIndex}, ${chIndex})'>â¬†ï¸</button>
        <button onclick='moveDown("canal", ${cIndex}, ${mIndex}, ${chIndex})'>â¬‡ï¸</button>`;
        canal.params.forEach((param,pIndex)=>{
          const pEl=document.createElement("div");
          pEl.className="level";
          pEl.innerHTML=`<input id="param-${cIndex}-${mIndex}-${chIndex}-${pIndex}" value="${param.nome||''}" placeholder="Nome do parÃ¢metro" onblur="data.campanhas[${cIndex}].marcas[${mIndex}].canais[${chIndex}].params[${pIndex}].nome=this.value; save()">
          <div class='allow-empty'><input type='checkbox' ${param.permitirVazio?'checked':''} onchange='toggleAllowEmpty(${cIndex},${mIndex},${chIndex},${pIndex},this.checked)'><label>Permitir valor vazio</label></div>
          <textarea id="val-param-${cIndex}-${mIndex}-${chIndex}-${pIndex}" placeholder="Valor" onblur="data.campanhas[${cIndex}].marcas[${mIndex}].canais[${chIndex}].params[${pIndex}].valor=this.value; save()">${param.valor||''}</textarea>
          <button onclick='duplicateParam(${cIndex},${mIndex},${chIndex},${pIndex})'>ğŸ“„</button>
          <button onclick='removeParam(${cIndex},${mIndex},${chIndex},${pIndex})'>ğŸ—‘ï¸</button>`;
          chEl.appendChild(pEl);
        });
        mEl.appendChild(chEl);
      });
      cEl.appendChild(mEl);
    });
    builder.appendChild(cEl);
  });
  restoreOpenDetails(openKeys);
  jsonPreview.textContent=JSON.stringify(generateFinalJson(),null,2);
}
function applySearch(query){const details=builder.querySelectorAll("details");const inputs=builder.querySelectorAll("input, textarea");details.forEach(d=>d.classList.remove("hidden"));inputs.forEach(i=>i.classList.remove("search-highlight"));if(!query.trim())return;query=query.toLowerCase();details.forEach(d=>d.classList.add("hidden"));inputs.forEach(el=>{const val=(el.value||"").toLowerCase();if(val.includes(query)){el.classList.add("search-highlight");let parent=el.closest("details");while(parent){parent.classList.remove("hidden");parent.open=true;parent=parent.parentElement.closest("details");}}});}
function validateJson(){const errors=[];const ids={};data.campanhas.forEach((c,cIndex)=>{if(!c.nome)errors.push({msg:"Campanha sem nome.",refs:[],type:"syntax"});c.marcas.forEach((m,mIndex)=>{if(!m.nome)errors.push({msg:`Marca sem nome em ${c.nome}`,refs:[],type:"syntax"});m.canais.forEach((ch,chIndex)=>{if(!ch.nome)errors.push({msg:`Canal sem nome em ${m.nome}`,refs:[`input-${cIndex}-${mIndex}-${chIndex}-id`],type:"syntax"});if(!ch.id)errors.push({msg:`Canal \"${ch.nome}\" sem ID.`,refs:[`id-${cIndex}-${mIndex}-${chIndex}`],type:"syntax"});if(!ids[ch.id])ids[ch.id]=[];ids[ch.id].push({ref:`id-${cIndex}-${mIndex}-${chIndex}`,path:`${c.nome} â€º ${m.nome} â€º ${ch.nome}`});ch.params.forEach((p,pIndex)=>{if(!p.nome)errors.push({msg:`ParÃ¢metro sem nome em ${ch.nome}`,refs:[`param-${cIndex}-${mIndex}-${chIndex}-${pIndex}`],type:"syntax"});if(!p.valor&&!p.permitirVazio)errors.push({msg:`ParÃ¢metro \"${p.nome}\" sem valor em ${ch.nome}`,refs:[`val-param-${cIndex}-${mIndex}-${chIndex}-${pIndex}`],type:"syntax"});});});});});for(const[id,entries]of Object.entries(ids)){if(id&&entries.length>1){const paths=entries.map(e=>`â€¢ ${e.path}`).join("<br>");const refs=entries.map(e=>e.ref);errors.push({msg:`ID duplicado: ${id} encontrado em:<br>${paths}`,refs,type:"dup"});}}if(errors.length){statusDiv.className="error";statusDiv.innerHTML="âŒ Erros detectados:<br>"+errors.map(e=>`<div class='error-item' style='color:${e.type==="dup"?"#e53935":"#fbc02d"}' onclick='scrollToErrorRefs(${JSON.stringify(e.refs)})'>${e.msg}</div>`).join("");highlightErrorFields(errors);}else{statusDiv.className="success";statusDiv.textContent="âœ… JSON vÃ¡lido!";}jsonPreview.textContent=JSON.stringify(generateFinalJson(),null,2);}
function highlightErrorFields(errors){document.querySelectorAll(".error-dup, .error-syntax").forEach(e=>e.classList.remove("error-dup","error-syntax"));errors.forEach(e=>{e.refs.forEach(r=>{const el=document.getElementById(r);if(el){el.classList.add(e.type==="dup"?"error-dup":"error-syntax");expandToElement(el);}});});}
function expandToElement(el){let parent=el.closest("details");while(parent){parent.open=true;parent=parent.parentElement.closest("details");}}
function scrollToErrorRefs(refs){if(!refs)return;if(typeof refs==="string")refs=[refs];let target=null;for(const ref of refs){const el=document.querySelector(`[id="${ref}"]`);if(el){target=el;break;}}if(target){target.scrollIntoView({behavior:'smooth',block:'center'});target.classList.add('blink');setTimeout(()=>target.classList.remove('blink'),2000);}}
function importJson(){const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=e=>{const f=e.target.files[0];const r=new FileReader();r.onload=ev=>{try{processImported(JSON.parse(ev.target.result));alert("ğŸ“‚ JSON importado!");}catch{alert("Erro ao importar JSON");}};r.readAsText(f);};i.click();}
function importFromURL(){const u=prompt("Cole a URL pÃºblica do JSON:");if(!u)return;fetch(u).then(r=>r.json()).then(j=>{processImported(j);alert("ğŸŒ JSON importado via URL!");}).catch(()=>alert("Erro ao importar via URL"));}
function processImported(j){data={campanhas:[]};Object.entries(j).forEach(([cn,ms])=>{const c={nome:cn,marcas:[]};Object.entries(ms).forEach(([mn,cs])=>{const m={nome:mn,canais:[]};Object.entries(cs).forEach(([ch,i])=>{const ps=Object.entries(i.params||{}).map(([n,v])=>({nome:n,valor:v,permitirVazio:v===""}));m.canais.push({nome:ch,id:i.id,params:ps});});c.marcas.push(m);});data.campanhas.push(c);});save();}
function clearAll(){if(confirm("Limpar tudo?")){data={campanhas:[]};localStorage.removeItem("json_builder_v486");render();location.reload();}}
function copyJson(){navigator.clipboard.writeText(JSON.stringify(generateFinalJson(),null,2));alert("ğŸ“‹ Copiado!");}
function downloadJson(){const b=new Blob([JSON.stringify(generateFinalJson(),null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="config.json";a.click();}
function generateFinalJson(){const f={};data.campanhas.forEach(c=>{if(!c.nome)return;f[c.nome]={};c.marcas.forEach(m=>{if(!m.nome)return;f[c.nome][m.nome]={};m.canais.forEach(ch=>{const p={};ch.params.forEach(pp=>{if(pp.nome)p[pp.nome]=pp.valor||"";});f[c.nome][m.nome][ch.nome]={id:Number(ch.id),params:p};});});});return f;}

render();
</script>
</body>
</html>
